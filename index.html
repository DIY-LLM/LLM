<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LigChem3D: Research-Ready Molecular Simulator</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h1 { margin-bottom: 10px; }
#controls { margin-bottom: 10px; }
#compoundInput { width: 400px; height: 50px; }
#viewer { width: 900px; height: 600px; border:1px solid black; margin-top: 10px; }
#dashboard { margin-top: 10px; border-top: 1px solid #ccc; padding-top: 10px; max-height:300px; overflow:auto; }
button { margin-right: 10px; }
</style>
</head>
<body>
<h1>LigChem3D: Research-Ready Molecular Simulator</h1>

<div id="controls">
<textarea id="compoundInput" placeholder="Enter SMILES, separated by commas">CCO,CC,O=C=O</textarea><br>
<button id="simulate">Visualize & Minimize</button>
<button id="merge">Merge Compounds</button>
<label>Temperature (K): <input type="number" id="temperature" value="300"></label>
<label>Solvent: 
<select id="solvent">
<option>Water</option>
<option>Organic</option>
<option>None</option>
</select>
</label>
</div>

<div id="viewer"></div>
<div id="dashboard"></div>

<!-- Include Three.js and OrbitControls -->
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js"></script>
<!-- Include OpenChemLib.js -->
<script src="https://unpkg.com/openchemlib/openchemlib-full.js"></script>

<script>
// --- Global Variables ---
let scene, camera, renderer, controls;
let moleculeObjects = [];
let moleculesData = [];

// --- Initialize Viewer ---
function initViewer() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, 900/600, 0.1, 2000);
    camera.position.set(0, 0, 60);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(900, 600);
    document.getElementById('viewer').appendChild(renderer.domElement);

    const light1 = new THREE.DirectionalLight(0xffffff, 0.8);
    light1.position.set(0, 0, 100);
    scene.add(light1);

    const light2 = new THREE.AmbientLight(0x404040);
    scene.add(light2);

    controls = new THREE.OrbitControls(camera, renderer.domElement);

    animate();
}

function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
}

// --- LigAdvisor-Style Data ---
function loadLigAdvisorData() {
    return {
        "CCO": { "name": "Ethanol", "targets": ["ADH1A","ADH1B"] },
        "CC": { "name": "Ethane", "targets": [] },
        "O=C=O": { "name": "Carbon dioxide", "targets": [] }
    };
}

// --- Energy Minimization + 3D Generation ---
function minimizeMolecule(mol) {
    try {
        mol.addImplicitHydrogens();
        mol.ensureHelperArrays(OCL.Molecule.cHelperNeighbours);
        OCL.Molecule3D.generate3DCoordinates(mol);
        OCL.MMFF94.optimize(mol);

        // Center molecule at origin
        let cx=0,cy=0,cz=0,n=mol.getAllAtoms();
        for(let i=0;i<n;i++){ cx+=mol.getAtomX(i); cy+=mol.getAtomY(i); cz+=mol.getAtomZ(i);}
        cx/=n; cy/=n; cz/=n;
        for(let i=0;i<n;i++){ 
            mol.setAtomX(i,mol.getAtomX(i)-cx);
            mol.setAtomY(i,mol.getAtomY(i)-cy);
            mol.setAtomZ(i,mol.getAtomZ(i)-cz);
        }
        return mol;
    } catch(e){
        console.warn('Minimization failed', e);
        return mol;
    }
}

// --- Render Molecule ---
function renderMolecule(mol, offsetX=0) {
    const group = new THREE.Group();

    // Atoms
    for(let i=0;i<mol.getAllAtoms();i++){
        const atom = mol.getAtomLabel(i);
        const color = atom==='O'?0xff0000: atom==='C'?0x000000:0x00ff00;
        const sphere = new THREE.Mesh(
            new THREE.SphereGeometry(0.6,16,16),
            new THREE.MeshPhongMaterial({color:color})
        );
        sphere.position.set(mol.getAtomX(i)+offsetX, mol.getAtomY(i), mol.getAtomZ(i));
        group.add(sphere);
    }

    // Bonds
    for(let b=0;b<mol.getAllBonds();b++){
        const from = mol.getBondAtom(0,b);
        const to = mol.getBondAtom(1,b);
        const x1 = mol.getAtomX(from)+offsetX, y1 = mol.getAtomY(from), z1 = mol.getAtomZ(from);
        const x2 = mol.getAtomX(to)+offsetX, y2 = mol.getAtomY(to), z2 = mol.getAtomZ(to);
        const geometry = new THREE.BufferGeometry().setFromPoints([
            new THREE.Vector3(x1,y1,z1),
            new THREE.Vector3(x2,y2,z2)
        ]);
        const line = new THREE.Line(geometry,new THREE.LineBasicMaterial({color:0x888888}));
        group.add(line);
    }

    scene.add(group);
    moleculeObjects.push(group);
}

// --- Merge Molecules ---
function mergeMolecules() {
    if(moleculesData.length<2) return;
    const merged = moleculesData.reduce((a,b)=>a.merge(b));
    moleculesData = [minimizeMolecule(merged)];
    moleculeObjects.forEach(obj=>scene.remove(obj));
    moleculeObjects = [];
    renderMolecule(moleculesData[0],0);
    updateDashboard(moleculesData);
}

// --- Update Dashboard ---
function updateDashboard(molArray) {
    const data = loadLigAdvisorData();
    const dashboard = document.getElementById('dashboard');
    dashboard.innerHTML = '';
    molArray.forEach(mol=>{
        const smiles = mol.toSmiles();
        const info = data[smiles]||{name:'Unknown',targets:[]};
        const div = document.createElement('div');
        div.innerHTML = `<b>${smiles}:</b> ${info.name}, Targets: ${info.targets.join(', ')}`;
        dashboard.appendChild(div);
    });

    const temperature = document.getElementById('temperature').value;
    const solvent = document.getElementById('solvent').value;
    const summary = document.createElement('div');
    summary.innerHTML = `<b>Conditions:</b> Temp: ${temperature}K, Solvent: ${solvent}`;
    dashboard.appendChild(summary);
}

// --- Simulate ---
function simulate() {
    moleculeObjects.forEach(obj=>scene.remove(obj));
    moleculeObjects = [];
    moleculesData = [];

    const input = document.getElementById('compoundInput').value.split(',').map(s=>s.trim());
    let offsetX = 0;
    input.forEach(smiles=>{
        const mol = OCL.Molecule.fromSmiles(smiles);
        const minimized = minimizeMolecule(mol);
        moleculesData.push(minimized);
        renderMolecule(minimized, offsetX);
        offsetX += 15;
    });

    updateDashboard(moleculesData);
}

// --- Event Listeners ---
document.getElementById('simulate').addEventListener('click',simulate);
document.getElementById('merge').addEventListener('click',mergeMolecules);

// --- Initialize ---
initViewer();
</script>
</body>
</html>

