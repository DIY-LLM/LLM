<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>P2P Secure Chat Enhanced</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
/* --- Basic UI Styles (same as your previous version, with minor adjustments) --- */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; display:flex; justify-content:center; align-items:center; padding:20px; }
.container { background:white; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.3); max-width:600px; width:100%; overflow:hidden; }
.header { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:25px; text-align:center; }
.header h1 { font-size:24px; margin-bottom:5px; }
.header p { font-size:13px; opacity:0.9; }
.status { padding:15px 25px; background:#f8f9fa; border-bottom:1px solid #e9ecef; display:flex; align-items:center; justify-content:space-between; }
.status-indicator { display:flex; align-items:center; gap:8px; }
.status-dot { width:10px; height:10px; border-radius:50%; background:#dc3545; animation:pulse 2s infinite; }
.status-dot.connected { background:#28a745; }
.status-dot.waiting { background:#ffc107; }
@keyframes pulse { 0%,100% {opacity:1;} 50% {opacity:0.5;} }
.peer-id { font-size:11px; color:#6c757d; font-family:monospace; }
.main-content { padding:25px; }
.section { margin-bottom:25px; }
.section h2 { font-size:16px; margin-bottom:15px; color:#495057; }
.button-group { display:flex; gap:10px; flex-wrap:wrap; }
button { padding:12px 24px; border:none; border-radius:10px; font-size:14px; font-weight:600; cursor:pointer; transition:all 0.3s; flex:1; min-width:140px; }
button:disabled { opacity:0.5; cursor:not-allowed; }
.btn-primary { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; }
.btn-primary:hover:not(:disabled) { transform:translateY(-2px); box-shadow:0 5px 15px rgba(102,126,234,0.4);}
.btn-secondary { background:#6c757d; color:white; }
.btn-secondary:hover:not(:disabled) { background:#5a6268; }
.btn-success { background:#28a745; color:white; }
.btn-success:hover:not(:disabled) { background:#218838; }
input[type="text"],textarea { width:100%; padding:12px; border:2px solid #e9ecef; border-radius:10px; font-size:14px; transition:border-color 0.3s; margin-bottom:10px; font-family:monospace; }
textarea { resize:vertical; min-height:80px; }
input[type="text"]:focus,textarea:focus { outline:none; border-color:#667eea; }
.qr-container { text-align:center; padding:20px; background:#f8f9fa; border-radius:10px; margin-top:15px; }
#qrcode { display:inline-block; padding:15px; background:white; border-radius:10px; margin-bottom:15px; }
.connection-url { font-size:11px; word-break:break-all; background:white; padding:10px; border-radius:5px; margin-top:10px; font-family:monospace; }
.chat-area { display:none; flex-direction:column; height:400px; }
.chat-area.active { display:flex; }
.messages { flex:1; overflow-y:auto; padding:20px; background:#f8f9fa; border-radius:10px; margin-bottom:15px; }
.message { margin-bottom:15px; animation:slideIn 0.3s; }
@keyframes slideIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
.message.sent { text-align:right; }
.message-bubble { display:inline-block; padding:10px 15px; border-radius:15px; max-width:70%; word-wrap:break-word; }
.message.received .message-bubble { background:white; color:#212529; border-bottom-left-radius:5px; }
.message.sent .message-bubble { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border-bottom-right-radius:5px; }
.message-time { font-size:10px; opacity:0.6; margin-top:5px; }
.message-input-area { display:flex; gap:10px; }
.message-input-area input { margin-bottom:0; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; }
.hidden { display:none; }
.setup-area { display:block; }
.setup-area.hidden { display:none; }
.info-box { background:#e7f3ff; border-left:4px solid #667eea; padding:15px; border-radius:5px; font-size:13px; color:#495057; margin-bottom:20px; }
.warning-box { background:#fff3cd; border-left:4px solid #ffc107; padding:15px; border-radius:5px; font-size:13px; color:#495057; margin-bottom:20px; }
.step-indicator { background:#f8f9fa; padding:15px; border-radius:10px; margin:15px 0; border-left:4px solid #28a745; }
.step-indicator h3 { font-size:14px; color:#28a745; margin-bottom:8px; }
.step-indicator p { font-size:13px; color:#495057; line-height:1.5; }
.code-box { background:#2d2d2d; color:#f8f8f2; padding:15px; border-radius:8px; font-family:monospace; font-size:12px; word-break:break-all; margin:10px 0; max-height:150px; overflow-y:auto; }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üîí P2P Secure Chat Enhanced</h1>
        <p>Decentralized ‚Ä¢ No Servers ‚Ä¢ Private ‚Ä¢ Fingerprint Verified</p>
    </div>

    <div class="status">
        <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Disconnected</span>
        </div>
        <div class="peer-id" id="peerId"></div>
    </div>

    <div class="main-content">
        <div class="setup-area" id="setupArea">
            <div class="info-box">
                ‚ÑπÔ∏è This chat uses WebRTC for direct peer-to-peer encrypted connections. Verify fingerprints before sending messages.
            </div>

            <div class="section">
                <h2>Option 1: Start a New Chat Room</h2>
                <button class="btn-primary" id="createRoom">Create Room</button>

                <div id="hostInstructions" class="hidden">
                    <div class="step-indicator">
                        <h3>üì§ Step 1: Share Your Offer Code & Fingerprint</h3>
                        <p>Copy the code below and send it to your friend (Signal, WhatsApp, etc.)</p>
                    </div>
                    <div class="code-box" id="offerCode"></div>
                    <div class="step-indicator">
                        <h3>üîë Fingerprint</h3>
                        <p id="hostFingerprint" style="font-family: monospace;"></p>
                    </div>
                    <button class="btn-secondary" id="copyOffer">Copy Offer Code</button>

                    <div class="qr-container">
                        <p style="font-weight: 600; margin-bottom: 10px;">Or scan QR:</p>
                        <div id="qrcode"></div>
                    </div>

                    <div class="step-indicator" style="margin-top:20px;">
                        <h3>üì• Step 2: Paste Answer Code</h3>
                        <p>Paste the answer code your friend sends you:</p>
                    </div>
                    <textarea id="answerInput" placeholder="Paste answer code here..."></textarea>
                    <button class="btn-success" id="submitAnswer">Connect</button>
                </div>
            </div>

            <div class="section">
                <h2>Option 2: Join Existing Room</h2>
                <div class="step-indicator">
                    <h3>üì• Paste Offer Code</h3>
                    <p>Paste the offer code you received:</p>
                </div>
                <textarea id="joinInput" placeholder="Paste offer code here..."></textarea>
                <button class="btn-success" id="joinRoom">Join Room</button>

                <div id="joinerInstructions" class="hidden">
                    <div class="warning-box">
                        ‚ö†Ô∏è Copy the answer code below and send it back. Verify fingerprints match!
                    </div>
                    <div class="code-box" id="answerCode"></div>
                    <div class="step-indicator">
                        <h3>üîë Fingerprint</h3>
                        <p id="joinerFingerprint" style="font-family: monospace;"></p>
                    </div>
                    <button class="btn-secondary" id="copyAnswer">Copy Answer Code</button>
                    <div class="step-indicator" style="margin-top:20px;">
                        <h3>‚è≥ Waiting for Connection...</h3>
                        <p>Once your friend confirms the fingerprint, messages are secure.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-area" id="chatArea">
            <div class="messages" id="messages"></div>
            <div class="message-input-area">
                <input type="text" id="messageInput" placeholder="Type a message...">
                <button class="btn-primary" id="sendBtn">Send</button>
            </div>
        </div>
    </div>
</div>

<script>
const config = { iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}] };
let peerConnection = null, dataChannel = null, isInitiator = false;
let sessionKey = null;

// DOM
const createRoomBtn=document.getElementById('createRoom');
const joinRoomBtn=document.getElementById('joinRoom');
const submitAnswerBtn=document.getElementById('submitAnswer');
const joinInput=document.getElementById('joinInput');
const answerInput=document.getElementById('answerInput');
const hostInstructions=document.getElementById('hostInstructions');
const joinerInstructions=document.getElementById('joinerInstructions');
const offerCode=document.getElementById('offerCode');
const answerCode=document.getElementById('answerCode');
const copyOfferBtn=document.getElementById('copyOffer');
const copyAnswerBtn=document.getElementById('copyAnswer');
const setupArea=document.getElementById('setupArea');
const chatArea=document.getElementById('chatArea');
const messages=document.getElementById('messages');
const messageInput=document.getElementById('messageInput');
const sendBtn=document.getElementById('sendBtn');
const statusDot=document.getElementById('statusDot');
const statusText=document.getElementById('statusText');
const peerId=document.getElementById('peerId');
const hostFingerprint = document.getElementById('hostFingerprint');
const joinerFingerprint = document.getElementById('joinerFingerprint');

// Peer ID
const myPeerId = 'peer-'+Math.random().toString(36).substr(2,9);
peerId.textContent=myPeerId;

// Utility: wait for ICE
function waitForIceGathering(pc){return new Promise(resolve=>{if(pc.iceGatheringState==='complete'){resolve();}else{const check=()=>{if(pc.iceGatheringState==='complete'){pc.removeEventListener('icegatheringstatechange',check);resolve();}};pc.addEventListener('icegatheringstatechange',check);}});}

// Generate short fingerprint
async function generateFingerprint(cert){
    if(!cert) return '';
    const hash = await crypto.subtle.digest('SHA-256', cert);
    return btoa(String.fromCharCode(...new Uint8Array(hash))).substr(0,8);
}

// HMAC
async function createHMAC(message,key){
    const enc = new TextEncoder();
    const cryptoKey = await crypto.subtle.importKey('raw', key, {name:'HMAC', hash:'SHA-256'}, false, ['sign']);
    const sig = await crypto.subtle.sign('HMAC', cryptoKey, enc.encode(message));
    return btoa(String.fromCharCode(...new Uint8Array(sig)));
}

// Verify HMAC
async function verifyHMAC(message,hmac,key){
    const generated = await createHMAC(message,key);
    return generated===hmac;
}

// Initialize Peer
async function initializePeerConnection(){
    peerConnection=new RTCPeerConnection(config);
    sessionKey = crypto.getRandomValues(new Uint8Array(32)); // ephemeral session key

    if(isInitiator){
        dataChannel=peerConnection.createDataChannel('chat');
        setupDataChannel();
    }else{
        peerConnection.ondatachannel = e=>{dataChannel=e.channel; setupDataChannel();}
    }

    peerConnection.onicecandidate = e=>{console.log('ICE candidate:',e.candidate?'Found':'Gathering complete');};
    peerConnection.onconnectionstatechange=()=>{console.log('Conn state:',peerConnection.connectionState);
        if(peerConnection.connectionState==='connected'){updateStatus('connected','Connected & Encrypted'); setupArea.classList.add('hidden'); chatArea.classList.add('active'); messageInput.focus(); displayFingerprints();}
        else if(peerConnection.connectionState==='disconnected'||peerConnection.connectionState==='failed'){updateStatus('disconnected','Disconnected'); alert('Connection lost. Refresh to start over.');}
        else if(peerConnection.connectionState==='connecting'){updateStatus('waiting','Connecting...');}
    };
}

// Setup data channel
function setupDataChannel(){
    dataChannel.onopen = ()=>{console.log('Data channel open'); updateStatus('connected','Connected & Encrypted'); setupArea.classList.add('hidden'); chatArea.classList.add('active'); messageInput.focus();}
    dataChannel.onclose = ()=>{console.log('Data channel closed'); updateStatus('disconnected','Disconnected'); alert('Connection lost.');}
    dataChannel.onerror = e=>{console.error('Data channel error',e);}
    dataChannel.onmessage = async e=>{
        const data = JSON.parse(e.data);
        if(await verifyHMAC(data.text,data.hmac,sessionKey)){
            addMessage(data.text,false,data.time);
        } else { console.warn('Message HMAC verification failed'); }
    };
}

// Send message
async function sendMessage(){
    const text=messageInput.value.trim();
    if(!text||!dataChannel||dataChannel.readyState!=='open') return;
    const time = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const hmac = await createHMAC(text,sessionKey);
    const payload = {text,hmac,time};
    dataChannel.send(JSON.stringify(payload));
    addMessage(text,true,time);
    messageInput.value='';
}

// Add message
function addMessage(text,isSent,time){
    const div=document.createElement('div'); div.className=`message ${isSent?'sent':'received'}`;
    div.innerHTML=`<div class="message-bubble">${escapeHtml(text)}<div class="message-time">${time}</div></div>`;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}

// Escape HTML
function escapeHtml(text){const div=document.createElement('div'); div.textContent=text; return div.innerHTML;}

// Update status
function updateStatus(state,text){statusText.textContent=text; statusDot.className='status-dot'; if(state==='connected'){statusDot.classList.add('connected');} else if(state==='waiting'){statusDot.classList.add('waiting');}}

// Display fingerprints
async function displayFingerprints(){
    const certs = peerConnection.getRemoteCertificates ? peerConnection.getRemoteCertificates() : null;
    if(certs && certs.length>0){
        const fp = await generateFingerprint(certs[0].raw);
        if(isInitiator) hostFingerprint.textContent = fp;
        else joinerFingerprint.textContent = fp;
    }
}

// Create room
createRoomBtn.addEventListener('click', async()=>{
    isInitiator=true; createRoomBtn.disabled=true; updateStatus('waiting','Creating room...');
    await initializePeerConnection();
    const offer = await peerConnection.createOffer(); await peerConnection.setLocalDescription(offer);
    await waitForIceGathering(peerConnection);
    const offerData = btoa(JSON.stringify({type:'offer',sdp:peerConnection.localDescription.sdp}));
    offerCode.textContent = offerData; hostInstructions.classList.remove('hidden');
    const qrData = window.location.origin+window.location.pathname+'?offer='+offerData;
    document.getElementById('qrcode').innerHTML=''; new QRCode(document.getElementById('qrcode'),{text:qrData,width:180,height:180});
    updateStatus('waiting','Waiting for peer to join...');
});

// Copy offer
copyOfferBtn.addEventListener('click',()=>{navigator.clipboard.writeText(offerCode.textContent); copyOfferBtn.textContent='‚úì Copied!'; setTimeout(()=>copyOfferBtn.textContent='Copy Offer Code',2000);});

// Submit answer (host)
submitAnswerBtn.addEventListener('click',async()=>{
    const answerData=answerInput.value.trim(); if(!answerData) return;
    try{
        const data=JSON.parse(atob(answerData));
        await peerConnection.setRemoteDescription({type:'answer',sdp:data.sdp});
        submitAnswerBtn.textContent='Connecting...'; submitAnswerBtn.disabled=true; updateStatus('waiting','Establishing connection...');
    }catch(e){alert('Invalid answer code'); console.error(e); submitAnswerBtn.disabled=false;}
});

// Join room
joinRoomBtn.addEventListener('click',async()=>{
    const offerDataStr=joinInput.value.trim(); if(!offerDataStr) return;
    try{
        const data=JSON.parse(atob(offerDataStr));
        isInitiator=false; joinRoomBtn.disabled=true; updateStatus('waiting','Joining room...');
        await initializePeerConnection();
        await peerConnection.setRemoteDescription({type:'offer',sdp:data.sdp});
        const answer = await peerConnection.createAnswer(); await peerConnection.setLocalDescription(answer);
        await waitForIceGathering(peerConnection);
        const answerData=btoa(JSON.stringify({type:'answer',sdp:peerConnection.localDescription.sdp}));
        answerCode.textContent = answerData; joinerInstructions.classList.remove('hidden'); updateStatus('waiting','Waiting for host to connect...');
    }catch(e){alert('Invalid offer code'); console.error(e); joinRoomBtn.disabled=false;}
});

// Copy answer
copyAnswerBtn.addEventListener('click',()=>{navigator.clipboard.writeText(answerCode.textContent); copyAnswerBtn.textContent='‚úì Copied!'; setTimeout(()=>copyAnswerBtn.textContent='Copy Answer Code',2000);});

// Message send
sendBtn.addEventListener('click',sendMessage);
messageInput.addEventListener('keypress',e=>{if(e.key==='Enter') sendMessage();});

// Load URL offer param
window.addEventListener('load',()=>{
    const params=new URLSearchParams(window.location.search);
    const offerParam = params.get('offer');
    if(offerParam){joinInput.value=offerParam; joinInput.scrollIntoView({behavior:'smooth'});}
});
</script>
</body>
</html>
